"use strict";
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
const arrays_js_1 = require("../../../../base/common/arrays.js");
const observable_js_1 = require("../../../../base/common/observable.js");
const hideUnchangedRegionsFeature_js_1 = require("../../../browser/widget/diffEditor/features/hideUnchangedRegionsFeature.js");
const utils_js_1 = require("../../../browser/widget/diffEditor/utils.js");
const languageFeatures_js_1 = require("../../../common/services/languageFeatures.js");
const outlineModel_js_1 = require("../../documentSymbols/browser/outlineModel.js");
const lifecycle_js_1 = require("../../../../base/common/lifecycle.js");
const event_js_1 = require("../../../../base/common/event.js");
let DiffEditorBreadcrumbsSource = class DiffEditorBreadcrumbsSource extends lifecycle_js_1.Disposable {
    constructor(_textModel, _languageFeaturesService, _outlineModelService) {
        super();
        this._textModel = _textModel;
        this._languageFeaturesService = _languageFeaturesService;
        this._outlineModelService = _outlineModelService;
        this._currentModel = (0, observable_js_1.observableValue)(this, undefined);
        const documentSymbolProviderChanged = (0, observable_js_1.observableSignalFromEvent)('documentSymbolProvider.onDidChange', this._languageFeaturesService.documentSymbolProvider.onDidChange);
        const textModelChanged = (0, observable_js_1.observableSignalFromEvent)('_textModel.onDidChangeContent', event_js_1.Event.debounce(e => this._textModel.onDidChangeContent(e), () => undefined, 100));
        this._register((0, observable_js_1.autorunWithStore)(async (reader, store) => {
            documentSymbolProviderChanged.read(reader);
            textModelChanged.read(reader);
            const src = store.add(new utils_js_1.DisposableCancellationTokenSource());
            const model = await this._outlineModelService.getOrCreate(this._textModel, src.token);
            if (store.isDisposed) {
                return;
            }
            this._currentModel.set(model, undefined);
        }));
    }
    getBreadcrumbItems(startRange, reader) {
        const m = this._currentModel.read(reader);
        if (!m) {
            return [];
        }
        const symbols = m.asListOfDocumentSymbols()
            .filter(s => startRange.contains(s.range.startLineNumber) && !startRange.contains(s.range.endLineNumber));
        symbols.sort((0, arrays_js_1.reverseOrder)((0, arrays_js_1.compareBy)(s => s.range.endLineNumber - s.range.startLineNumber, arrays_js_1.numberComparator)));
        return symbols.map(s => ({ name: s.name, kind: s.kind, startLineNumber: s.range.startLineNumber }));
    }
};
DiffEditorBreadcrumbsSource = __decorate([
    __param(1, languageFeatures_js_1.ILanguageFeaturesService),
    __param(2, outlineModel_js_1.IOutlineModelService)
], DiffEditorBreadcrumbsSource);
hideUnchangedRegionsFeature_js_1.HideUnchangedRegionsFeature.setBreadcrumbsSourceFactory((textModel, instantiationService) => {
    return instantiationService.createInstance(DiffEditorBreadcrumbsSource, textModel);
});
//# sourceMappingURL=contribution.js.map